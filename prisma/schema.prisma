// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "mysql"
}

model User {
  id                   Int       @id @default(autoincrement())
  email                String    @unique
  password             String
  firstName            String?
  lastName             String?
  avatarId             Int?      @unique
  phoneNumber          String?
  dateOfBirth          DateTime?
  role                 String    @default("student")
  verifyToken          String?
  resetPasswordToken   String?
  resetPasswordExpires DateTime?
  isVerified           Boolean   @default(false)
  createdAt            DateTime  @default(now())
  updatedAt            DateTime? @updatedAt
  isDestroyed          Boolean   @default(false)

  // relations
  avatar                 Resource?               @relation("UserAvatar", fields: [avatarId], references: [id], onDelete: SetNull)
  courses                Course[]                @relation("LecturerCourses")
  enrollments            Enrollment[]
  reviews                CourseReview[]
  blogPosts              BlogPost[]              @relation("AuthorPosts")
  lecturerProfile        LecturerProfile?
  lecturerPayout         LecturerPayout[]
  submissions            Submission[]
  blogComments           BlogComment[]
  wishlist               Wishlist[]
  cart                   Cart?
  orders                 Order[]
  transactions           Transaction[]
  lecturerPayoutAccounts LecturerPayoutAccount[]
  keyToken               KeyToken?
  revenues               Revenue[]
  notifications          Notification[]
}

model KeyToken {
  id               Int      @id @default(autoincrement())
  userId           Int      @unique
  publicKey        String
  privateKey       String
  refreshToken     String?  @db.Text
  refreshTokenUsed Json
  kid              String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  isDestroyed      Boolean  @default(false)

  // relations
  user User @relation(fields: [userId], references: [id])
}

model Role {
  id          Int       @id @default(autoincrement())
  name        String    @unique
  permissions Json
  inherits    Json
  createdAt   DateTime  @default(now())
  updatedAt   DateTime? @updatedAt
  isDestroyed Boolean   @default(false)
}

model Course {
  id            Int       @id @default(autoincrement())
  lecturerId    Int
  categoryId    Int?
  thumbnailId   Int?      @unique
  name          String
  lecturerName  String?
  duration      String?
  totalStudents Int       @default(0)
  totalLessons  Int       @default(0)
  totalQuizzes  Int       @default(0)
  level         String?
  overview      String?
  price         Float     @default(0)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime? @updatedAt
  status        String    @default("draft") // draft | pending | published | rejected
  isDestroyed   Boolean   @default(false)

  // relations
  lecturer    User            @relation(fields: [lecturerId], references: [id], name: "LecturerCourses")
  category    CourseCategory? @relation(fields: [categoryId], references: [id])
  thumbnail   Resource?       @relation("CourseThumbnail", fields: [thumbnailId], references: [id], onDelete: SetNull)
  modules     Module[]
  reviews     CourseReview[]
  enrollments Enrollment[]
  orderItems  OrderItem[]
  revenues    Revenue[]
  courseFAQs  CourseFAQ[]
  assessments Assessment[]
  cartItems   CartItem[]
}

model CourseCategory {
  id          Int       @id @default(autoincrement())
  name        String
  slug        String    @unique
  createdAt   DateTime  @default(now())
  updatedAt   DateTime? @updatedAt
  isDestroyed Boolean   @default(false)

  // relations
  courses Course[]
}

model CourseFAQ {
  id          Int       @id @default(autoincrement())
  courseId    Int
  question    String    @db.Text
  answer      String?   @db.Text
  createdAt   DateTime  @default(now())
  updatedAt   DateTime? @updatedAt
  isDestroyed Boolean   @default(false)

  // relations
  course Course @relation(fields: [courseId], references: [id])
}

model CourseReview {
  id            Int       @id @default(autoincrement())
  courseId      Int
  studentId     Int
  studentName   String?
  studentAvatar String?
  rating        Int
  content       String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime? @updatedAt
  isDestroyed   Boolean   @default(false)

  // relations
  course  Course @relation(fields: [courseId], references: [id])
  student User   @relation(fields: [studentId], references: [id])
}

model Module {
  id           Int       @id @default(autoincrement())
  courseId     Int
  title        String
  description  String?
  duration     String?
  totalLessons Int       @default(0)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime? @updatedAt
  isDestroyed  Boolean   @default(false)

  // relations
  course  Course   @relation(fields: [courseId], references: [id])
  lessons Lesson[]
}

model Lesson {
  id            Int       @id @default(autoincrement())
  lessonFileId  Int?      @unique
  moduleId      Int
  title         String
  description   String?
  note          String?
  lessonVideoId Int?      @unique
  duration      String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime? @updatedAt
  isDestroyed   Boolean   @default(false)

  // relations
  module      Module       @relation(fields: [moduleId], references: [id])
  lessonFile  Resource?    @relation("LessonFile", fields: [lessonFileId], references: [id], onDelete: SetNull)
  lessonVideo Resource?    @relation("LessonVideo", fields: [lessonVideoId], references: [id], onDelete: SetNull)
  quizzes     Quiz[]
  assessments Assessment[]
}

model Resource {
  id          Int       @id @default(autoincrement())
  publicId    String    @unique
  fileSize    Int?
  fileType    String?
  fileUrl     String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime? @updatedAt
  isDestroyed Boolean   @default(false)

  // relations
  userAvatar          User?            @relation("UserAvatar")
  courseThumbnail     Course?          @relation("CourseThumbnail")
  lessonFile          Lesson?          @relation("LessonFile")
  lessonVideo         Lesson?          @relation("LessonVideo")
  blogThumbnail       BlogPost?        @relation("BlogThumbnail")
  lecturerProfileFile LecturerProfile? @relation("LecturerProfileFile")
}

model Enrollment {
  id             Int       @id @default(autoincrement())
  studentId      Int
  courseId       Int
  status         String    @default("enrolled")
  progress       Float     @default(0)
  lastAccessedAt DateTime?
  createdAt      DateTime  @default(now())
  isDestroyed    Boolean   @default(false)

  // relations
  student User   @relation(fields: [studentId], references: [id])
  course  Course @relation(fields: [courseId], references: [id])
}

model Quiz {
  id           Int       @id @default(autoincrement())
  lessonId     Int
  title        String
  description  String?
  timeLimit    Int?
  passingScore Int?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime? @updatedAt
  isDestroyed  Boolean   @default(false)

  // relations
  lesson      Lesson       @relation(fields: [lessonId], references: [id])
  questions   Question[]
  submissions Submission[]
}

model Question {
  id            Int       @id @default(autoincrement())
  quizId        Int
  question      String
  type          String
  options       Json?
  correctAnswer String?
  point         Int?      @default(1)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime? @updatedAt
  isDestroyed   Boolean   @default(false)

  // relations
  quiz Quiz @relation(fields: [quizId], references: [id])
}

model Order {
  id            Int      @id @default(autoincrement())
  studentId     Int
  lecturer      String?
  totalPrice    Float?   @default(0)
  paymentMethod String?
  status        String?  @default("pending")
  createdAt     DateTime @default(now())
  isDestroyed   Boolean  @default(false)

  // relations
  student User        @relation(fields: [studentId], references: [id])
  items   OrderItem[]
  revenue Revenue?
}

model OrderItem {
  id          Int      @id @default(autoincrement())
  orderId     Int
  courseId    Int
  price       Float?
  lecturerId  Int?
  createdAt   DateTime @default(now())
  isDestroyed Boolean  @default(false)

  // relations
  order  Order  @relation(fields: [orderId], references: [id])
  course Course @relation(fields: [courseId], references: [id])

  @@unique([orderId, courseId])
}

model Coupon {
  id              Int       @id @default(autoincrement())
  name            String
  description     String?
  status          String?
  customerGroup   String?
  code            String    @unique
  categoryId      Int?
  quantity        Int?
  usesPerCustomer Int?
  priority        String?
  actions         String?
  type            String?
  amount          Float?
  startingDate    DateTime?
  startingTime    String?
  endingDate      DateTime?
  endingTime      String?
  isUnlimited     Boolean?  @default(false)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime? @updatedAt
  isDestroyed     Boolean   @default(false)

  // relations
  category CouponCategory? @relation(fields: [categoryId], references: [id])
}

model CouponCategory {
  id          Int       @id @default(autoincrement())
  name        String
  slug        String    @unique
  createdAt   DateTime  @default(now())
  updatedAt   DateTime? @updatedAt
  isDestroyed Boolean   @default(false)

  // relations
  coupons Coupon[]
}

model Submission {
  id           Int       @id @default(autoincrement())
  assessmentId Int
  quizId       Int
  studentId    Int
  score        Float?
  status       String?
  feedback     String?
  submittedAt  DateTime?
  isDestroyed  Boolean?  @default(false)

  // relations
  student    User       @relation(fields: [studentId], references: [id])
  assessment Assessment @relation(fields: [assessmentId], references: [id])
  quiz       Quiz       @relation(fields: [quizId], references: [id])
}

model Assessment {
  id               Int       @id @default(autoincrement())
  courseId         Int
  lessonId         Int?
  title            String
  type             String?
  dueDate          DateTime?
  status           String?
  totalSubmissions Int?
  averageScore     Float?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  isDestroyed      Boolean   @default(false)

  // relations
  submissions Submission[]
  course      Course       @relation(fields: [courseId], references: [id])
  lesson      Lesson?      @relation(fields: [lessonId], references: [id])
}

model BlogPost {
  id            Int       @id @default(autoincrement())
  authorId      Int
  categoryId    Int?
  title         String
  slug          String?
  content       String?
  thumbnailId   Int?      @unique
  totalComments Int?      @default(0)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime? @updatedAt
  isDestroyed   Boolean   @default(false)

  // relations
  author    User          @relation(fields: [authorId], references: [id], name: "AuthorPosts")
  category  BlogCategory? @relation(fields: [categoryId], references: [id])
  thumbnail Resource?     @relation("BlogThumbnail", fields: [thumbnailId], references: [id], onDelete: SetNull)
  comments  BlogComment[]
}

model BlogCategory {
  id          Int       @id @default(autoincrement())
  name        String
  slug        String    @unique
  createdAt   DateTime  @default(now())
  updatedAt   DateTime? @updatedAt
  isDestroyed Boolean   @default(false)

  // relations
  posts BlogPost[]
}

model BlogComment {
  id          Int       @id @default(autoincrement())
  blogId      Int
  userId      Int
  content     String?
  parentId    Int?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime? @updatedAt
  isDestroyed Boolean   @default(false)

  // relations
  post     BlogPost      @relation(fields: [blogId], references: [id])
  user     User          @relation(fields: [userId], references: [id])
  parent   BlogComment?  @relation("CommentReplies", fields: [parentId], references: [id])
  children BlogComment[] @relation("CommentReplies")
}

model Wishlist {
  id              Int       @id @default(autoincrement())
  userId          Int
  courseId        Int
  courseThumbnail String?
  courseName      String?
  lecturer        String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime? @updatedAt
  isDestroyed     Boolean   @default(false)

  // relations
  user User @relation(fields: [userId], references: [id])
}

model Cart {
  id          Int      @id @default(autoincrement())
  userId      Int      @unique
  courseName  String?
  lecturer    String?
  updatedAt   DateTime @updatedAt
  createdAt   DateTime @default(now())
  isDestroyed Boolean  @default(false)

  // Relations
  user  User       @relation(fields: [userId], references: [id])
  items CartItem[]
}

//Thêm model cartItem
model CartItem {
  id        Int      @id @default(autoincrement())
  cartId    Int
  courseId  Int
  price     Float // Lưu giá tại thời điểm thêm vào giỏ
  createdAt DateTime @default(now())

  // Relations
  cart   Cart   @relation(fields: [cartId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id])

  // Đảm bảo 1 khóa học chỉ xuất hiện 1 lần trong 1 giỏ hàng
  @@unique([cartId, courseId])
}

model Transaction {
  id               Int      @id @default(autoincrement())
  userId           Int
  userRole         String?
  amount           Float?
  paymentMethod    String?
  status           String?
  gatewayReference String?
  createdAt        DateTime @default(now())
  isDestroyed      Boolean  @default(false)

  // relations
  user                User                 @relation(fields: [userId], references: [id])
  studentTransactions TransactionStudent[]
}

model TransactionStudent {
  id             Int      @id @default(autoincrement())
  transactionId  Int
  orderId        Int?
  courseId       Int?
  isDiscount     Boolean? @default(false)
  discountAmount Float?
  discountCode   String?
  createdAt      DateTime @default(now())
  isDestroyed    Boolean  @default(false)

  // relations
  transaction Transaction @relation(fields: [transactionId], references: [id])
}

model LecturerProfile {
  id                Int       @id @default(autoincrement())
  lecturerId        Int       @unique
  lecturerFileId    Int?      @unique
  gender            String?
  nationality       String?
  professionalTitle String?
  beginStudies      DateTime?
  highestDegree     String?
  totalStudents     Int?
  totalCourses      Int?
  avgRating         Float?
  bio               String?
  isActive          Boolean   @default(false)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime? @updatedAt
  isDestroyed       Boolean   @default(false)

  // relations
  lecturer     User      @relation(fields: [lecturerId], references: [id])
  lecturerFile Resource? @relation("LecturerProfileFile", fields: [lecturerFileId], references: [id], onDelete: SetNull)
}

model LecturerPayout {
  id              Int       @id @default(autoincrement())
  transactionId   Int?
  lecturerId      Int
  payoutAccountId Int?
  currency        String?
  amount          Float?
  payoutMethod    String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime? @updatedAt
  status          String    @default("success") // success | failed
  isDestroyed     Boolean   @default(false)

  // relations
  lecturer User @relation(fields: [lecturerId], references: [id])
}

model LecturerPayoutAccount {
  id             Int       @id @default(autoincrement())
  lecturerId     Int
  cardType       String?
  cardNumber     String?
  cardExpireDate DateTime?
  cardCVV        Int?
  cardHolderName String?
  isDefault      Boolean?  @default(false)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime? @updatedAt
  isDestroyed    Boolean   @default(false)

  // relations
  lecturer User @relation(fields: [lecturerId], references: [id])
}

model Revenue {
  id         Int  @id @default(autoincrement())
  orderId    Int  @unique
  lecturerId Int?
  courseId   Int

  totalAmount  Float
  platformFee  Float
  lecturerEarn Float

  createdAt DateTime @default(now())

  // Relations
  order    Order  @relation(fields: [orderId], references: [id])
  lecturer User?  @relation(fields: [lecturerId], references: [id])
  course   Course @relation(fields: [courseId], references: [id])
}

model Notification {
  id        Int     @id @default(autoincrement())
  userId    Int
  title     String
  message   String  @db.Text
  type      String  @default("info") // "order", "payment", "message", "info"
  relatedId Int?    // Link to order, payment, etc.
  isRead    Boolean @default(false)
  createdAt DateTime @default(now())
  isDestroyed Boolean @default(false)

  // Relations
  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([createdAt])
}

// model Conversation {
//   id            Int      @id @default(autoincrement())
//   participants  Json?
//   lastMessageAt DateTime?
//   createdAt     DateTime? @default(now())
// }
